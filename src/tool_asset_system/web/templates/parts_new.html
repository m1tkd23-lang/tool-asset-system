<!-- templates/parts_new.html -->
{% extends "base.html" %}
{% block content %}

<h2>New Part</h2>

<form method="post" class="edit-form">
    <label>Layer
        <select id="layer" name="layer">
            {% for l in layers %}
            <option value="{{l.code}}" {% if selected_layer==l.code %}selected{% endif %}>
                {{l.code}} / {{l.label}}
            </option>
            {% endfor %}
        </select>
    </label>

    <label>Category（辞書）
        <select id="category" name="category">
            <option value="">(none)</option>
            {% for c in categories %}
            <option value="{{c.code}}">{{c.code}} / {{c.label}}</option>
            {% endfor %}
        </select>
        <small class="text-muted">※ free許可レイヤーのみ categoryなし可（DBが判定）</small>
    </label>

    <label>Category free text（任意）
        <input type="text" name="category_free" value="{{form.get('category_free','')}}">
    </label>

    <label>Maker
        <input type="text" name="maker" required value="{{form.get('maker','')}}">
    </label>

    <label>Part No
        <input type="text" name="part_no" required value="{{form.get('part_no','')}}">
    </label>

    <label>Unit
        <input type="text" name="unit" value="{{form.get('unit','EA')}}">
    </label>

    <label>Display name（任意）
        <input type="text" name="name" value="{{form.get('name','')}}">
    </label>

    <label>Maker part name（任意）
        <input type="text" name="maker_part_name" value="{{form.get('maker_part_name','')}}">
    </label>

    <div class="form-actions">
        <button type="submit" class="btn">Add</button>
    </div>
</form>

<script>
    // layer変更時にカテゴリ候補を取り直す
    const layerSel = document.getElementById("layer");
    const catSel = document.getElementById("category");

    async function refreshCategories() {
        const layer = layerSel.value;
        const res = await fetch(`/api/categories?layer=${encodeURIComponent(layer)}`);
        const cats = await res.json();

        catSel.innerHTML = `<option value="">(none)</option>`;
        for (const c of cats) {
            const opt = document.createElement("option");
            opt.value = c.code;
            opt.textContent = `${c.code} / ${c.label}`;
            catSel.appendChild(opt);
        }
    }

    layerSel.addEventListener("change", refreshCategories);

    // 初期表示のselected_layerに合わせてカテゴリを同期したい場合はこれもON
    // refreshCategories();
</script>

{% endblock %}